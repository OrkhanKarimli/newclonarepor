{"version":3,"file":"single-spa-react.js","sources":["../../src/single-spa-react.js"],"sourcesContent":["/* We don't import parcel.component.js from this file intentionally. See comment\n * in that file for why\n */\n\n// React context that gives any react component the single-spa props\nexport let SingleSpaContext = null;\n\nconst defaultOpts = {\n  // required opts\n  React: null,\n  ReactDOM: null,\n  rootComponent: null,\n  loadRootComponent: null,\n  suppressComponentDidCatchWarning: false,\n  domElements: {},\n\n  // optional opts\n  errorBoundary: null,\n  domElementGetter: null,\n  parcelCanUpdate: true, // by default, allow parcels created with single-spa-react to be updated\n};\n\nexport default function singleSpaReact(userOpts) {\n  if (typeof userOpts !== \"object\") {\n    throw new Error(`single-spa-react requires a configuration object`);\n  }\n\n  const opts = {\n    ...defaultOpts,\n    ...userOpts,\n  };\n\n  if (!opts.React) {\n    throw new Error(`single-spa-react must be passed opts.React`);\n  }\n\n  if (!opts.ReactDOM) {\n    throw new Error(`single-spa-react must be passed opts.ReactDOM`);\n  }\n\n  if (!opts.rootComponent && !opts.loadRootComponent) {\n    throw new Error(\n      `single-spa-react must be passed opts.rootComponent or opts.loadRootComponent`\n    );\n  }\n\n  if (opts.errorBoundary && typeof opts.errorBoundary !== \"function\") {\n    throw Error(\n      `The errorBoundary opt for single-spa-react must either be omitted or be a function that returns React elements`\n    );\n  }\n\n  if (!SingleSpaContext && opts.React.createContext) {\n    SingleSpaContext = opts.React.createContext();\n  }\n\n  const lifecycles = {\n    bootstrap: bootstrap.bind(null, opts),\n    mount: mount.bind(null, opts),\n    unmount: unmount.bind(null, opts),\n  };\n\n  if (opts.parcelCanUpdate) {\n    lifecycles.update = update.bind(null, opts);\n  }\n\n  return lifecycles;\n}\n\nfunction bootstrap(opts, props) {\n  if (opts.rootComponent) {\n    // This is a class or stateless function component\n    return Promise.resolve();\n  } else {\n    // They passed a promise that resolves with the react component. Wait for it to resolve before mounting\n    return opts.loadRootComponent(props).then((resolvedComponent) => {\n      opts.rootComponent = resolvedComponent;\n    });\n  }\n}\n\nfunction mount(opts, props) {\n  return new Promise((resolve, reject) => {\n    if (\n      !opts.suppressComponentDidCatchWarning &&\n      atLeastReact16(opts.React) &&\n      !opts.errorBoundary\n    ) {\n      if (!opts.rootComponent.prototype) {\n        console.warn(\n          `single-spa-react: ${\n            props.name || props.appName || props.childAppName\n          }'s rootComponent does not implement an error boundary.  If using a functional component, consider providing an opts.errorBoundary to singleSpaReact(opts).`\n        );\n      } else if (!opts.rootComponent.prototype.componentDidCatch) {\n        console.warn(\n          `single-spa-react: ${\n            props.name || props.appName || props.childAppName\n          }'s rootComponent should implement componentDidCatch to avoid accidentally unmounting the entire single-spa application.`\n        );\n      }\n    }\n\n    const domElementGetter = chooseDomElementGetter(opts, props);\n\n    if (typeof domElementGetter !== \"function\") {\n      throw new Error(\n        `single-spa-react: the domElementGetter for react application '${\n          props.appName || props.name\n        }' is not a function`\n      );\n    }\n\n    const whenFinished = function () {\n      resolve(this);\n    };\n\n    const elementToRender = getElementToRender(opts, props);\n    const domElement = getRootDomEl(domElementGetter, props);\n    const renderedComponent = reactDomRender({\n      elementToRender,\n      domElement,\n      whenFinished,\n      opts,\n    });\n    opts.domElements[props.name] = domElement;\n  });\n}\n\nfunction unmount(opts, props) {\n  return Promise.resolve().then(() => {\n    opts.ReactDOM.unmountComponentAtNode(opts.domElements[props.name]);\n    delete opts.domElements[props.name];\n  });\n}\n\nfunction update(opts, props) {\n  return new Promise((resolve, reject) => {\n    const whenFinished = function () {\n      resolve(this);\n    };\n\n    const elementToRender = getElementToRender(opts, props);\n    const renderedComponent = reactDomRender({\n      elementToRender,\n      domElement: opts.domElements[props.name],\n      whenFinished,\n      opts,\n    });\n  });\n}\n\nfunction getRootDomEl(domElementGetter, props) {\n  const el = domElementGetter(props);\n  if (!el) {\n    throw new Error(\n      `single-spa-react: domElementGetter function for application '${\n        props.appName || props.name\n      }' did not return a valid dom element. Please pass a valid domElement or domElementGetter via opts or props`\n    );\n  }\n\n  return el;\n}\n\nfunction atLeastReact16(React) {\n  if (\n    React &&\n    typeof React.version === \"string\" &&\n    React.version.indexOf(\".\") >= 0\n  ) {\n    const majorVersionString = React.version.slice(\n      0,\n      React.version.indexOf(\".\")\n    );\n    try {\n      return Number(majorVersionString) >= 16;\n    } catch (err) {\n      return false;\n    }\n  } else {\n    return false;\n  }\n}\n\nfunction chooseDomElementGetter(opts, props) {\n  if (props.domElement) {\n    return () => props.domElement;\n  } else if (props.domElementGetter) {\n    return props.domElementGetter;\n  } else if (opts.domElementGetter) {\n    return opts.domElementGetter;\n  } else {\n    return defaultDomElementGetter(props);\n  }\n}\n\nfunction defaultDomElementGetter(props) {\n  const appName = props.appName || props.name;\n  if (!appName) {\n    throw Error(\n      `single-spa-react was not given an application name as a prop, so it can't make a unique dom element container for the react application`\n    );\n  }\n  const htmlId = `single-spa-application:${appName}`;\n\n  return function defaultDomEl() {\n    let domElement = document.getElementById(htmlId);\n    if (!domElement) {\n      domElement = document.createElement(\"div\");\n      domElement.id = htmlId;\n      document.body.appendChild(domElement);\n    }\n\n    return domElement;\n  };\n}\n\nfunction reactDomRender({ opts, elementToRender, domElement, whenFinished }) {\n  if (\n    [\n      \"createRoot\",\n      \"unstable_createRoot\",\n      \"createBlockingRoot\",\n      \"unstable_createBlockingRoot\",\n    ].indexOf(opts.renderType) >= 0\n  ) {\n    return opts.ReactDOM[opts.renderType](domElement).render(\n      elementToRender,\n      whenFinished\n    );\n  }\n\n  if (opts.renderType === \"createBlockingRoot\") {\n    return opts.ReactDOM.createBlockingRoot(domElement).render(\n      elementToRender,\n      whenFinished\n    );\n  }\n\n  if (opts.renderType === \"hydrate\") {\n    return opts.ReactDOM.hydrate(elementToRender, domElement, whenFinished);\n  }\n\n  // default to this if 'renderType' is null or doesn't match the other options\n  return opts.ReactDOM.render(elementToRender, domElement, whenFinished);\n}\n\nfunction getElementToRender(opts, props) {\n  const rootComponentElement = opts.React.createElement(\n    opts.rootComponent,\n    props\n  );\n\n  let elementToRender = SingleSpaContext\n    ? opts.React.createElement(\n        SingleSpaContext.Provider,\n        { value: props },\n        rootComponentElement\n      )\n    : rootComponentElement;\n\n  if (opts.errorBoundary) {\n    opts.errorBoundaryClass =\n      opts.errorBoundaryClass || createErrorBoundary(opts);\n    elementToRender = opts.React.createElement(\n      opts.errorBoundaryClass,\n      props,\n      elementToRender\n    );\n  }\n\n  return elementToRender;\n}\n\nfunction createErrorBoundary(opts) {\n  // Avoiding babel output for class syntax and super()\n  // to avoid bloat\n  function SingleSpaReactErrorBoundary(props) {\n    // super\n    opts.React.Component.apply(this, arguments);\n\n    this.state = {\n      caughtError: null,\n      caughtErrorInfo: null,\n    };\n\n    SingleSpaReactErrorBoundary.displayName = `SingleSpaReactErrorBoundary(${props.name})`;\n  }\n\n  SingleSpaReactErrorBoundary.prototype = Object.create(\n    opts.React.Component.prototype\n  );\n\n  SingleSpaReactErrorBoundary.prototype.render = function () {\n    if (this.state.caughtError) {\n      return opts.errorBoundary(\n        this.state.caughtError,\n        this.state.caughtErrorInfo,\n        this.props\n      );\n    } else {\n      return this.props.children;\n    }\n  };\n\n  SingleSpaReactErrorBoundary.prototype.componentDidCatch = function (\n    err,\n    info\n  ) {\n    this.setState({\n      caughtError: err,\n      caughtErrorInfo: info,\n    });\n  };\n\n  return SingleSpaReactErrorBoundary;\n}\n"],"names":["userOpts","_typeof","Error","opts","defaultOpts","React","ReactDOM","rootComponent","loadRootComponent","errorBoundary","SingleSpaContext","createContext","lifecycles","bootstrap","bind","mount","unmount","parcelCanUpdate","update","suppressComponentDidCatchWarning","domElements","domElementGetter","props","Promise","resolve","then","resolvedComponent","reject","version","indexOf","majorVersionString","slice","Number","err","atLeastReact16","prototype","componentDidCatch","console","warn","name","appName","childAppName","domElement","htmlId","document","getElementById","createElement","id","body","appendChild","defaultDomElementGetter","chooseDomElementGetter","elementToRender","getElementToRender","el","getRootDomEl","reactDomRender","whenFinished","this","unmountComponentAtNode","renderType","render","createBlockingRoot","hydrate","rootComponentElement","Provider","value","errorBoundaryClass","SingleSpaReactErrorBoundary","Component","apply","arguments","state","caughtError","caughtErrorInfo","displayName","Object","create","children","info","setState","createErrorBoundary"],"mappings":"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"}