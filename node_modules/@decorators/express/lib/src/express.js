"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const di_1 = require("@decorators/di");
const meta_1 = require("./meta");
const middleware_1 = require("./middleware");
/**
 * Attach controllers to express application
 *
 * @param {Express} app Express application
 * @param {Type[]} controllers Controllers array
 */
function attachControllers(app, controllers) {
    controllers.forEach((controller) => registerController(app, controller));
    // error middleware must be registered as the very last one
    app.use(middleware_1.errorMiddlewareHandler());
}
exports.attachControllers = attachControllers;
/**
 * Register controller via registering new Router
 *
 * @param {Application} app
 * @param {ExpressClass} Controller
 * @returns
 */
function registerController(app, Controller) {
    const controller = getController(Controller);
    const meta = meta_1.getMeta(controller);
    const router = express_1.Router();
    const routes = meta.routes;
    const url = meta.url;
    const params = meta.params;
    /**
     * Wrap all registered middleware with helper function
     * that can instantiate or get from the container instance of the class
     * or execute given middleware function
     * @see getMiddleware
     */
    const routerMiddleware = (meta.middleware || [])
        .map(middleware => middleware_1.middlewareHandler(middleware));
    /**
     * Apply router middleware
     */
    if (routerMiddleware.length) {
        router.use(...routerMiddleware);
    }
    /**
     * Applying registered routes
     */
    for (const methodName of Object.keys(routes)) {
        const route = routes[methodName];
        const routeHandler = (req, res, next) => {
            const args = extractParameters(req, res, next, params[methodName]);
            const handler = controller[methodName].apply(controller, args);
            if (handler instanceof Promise) {
                handler.catch(next);
            }
            return handler;
        };
        const routeMiddleware = (route.middleware || [])
            .map(middleware => middleware_1.middlewareHandler(middleware));
        router[route.method].apply(router, [
            route.url, ...routeMiddleware, routeHandler
        ]);
    }
    app.use(url, router);
    return app;
}
/**
 * Extract parameters for handlers
 *
 * @param {Request} req
 * @param {Response} res
 * @param {NextFunction} next
 * @param {ParameterConfiguration[]} params
 *
 * @returns {any[]}
 */
function extractParameters(req, res, next, params) {
    if (!params || !params.length) {
        return [req, res, next];
    }
    const args = [];
    for (const { name, index, type } of params) {
        switch (type) {
            case meta_1.ParameterType.RESPONSE:
                args[index] = res;
                break;
            case meta_1.ParameterType.REQUEST:
                args[index] = getParam(req, null, name);
                break;
            case meta_1.ParameterType.NEXT:
                args[index] = next;
                break;
            case meta_1.ParameterType.PARAMS:
                args[index] = getParam(req, 'params', name);
                break;
            case meta_1.ParameterType.QUERY:
                args[index] = getParam(req, 'query', name);
                break;
            case meta_1.ParameterType.BODY:
                args[index] = getParam(req, 'body', name);
                break;
            case meta_1.ParameterType.HEADERS:
                args[index] = getParam(req, 'headers', name);
                break;
            case meta_1.ParameterType.COOKIES:
                args[index] = getParam(req, 'cookies', name);
                break;
        }
    }
    return args;
}
/**
 * Get controller instance from container or instantiate one
 *
 * @param {any} Controller
 *
 * @returns {ExpressClass}
 */
function getController(Controller) {
    try {
        return di_1.Container.get(Controller);
    }
    catch (_a) {
        return new Controller();
    }
}
/**
 * Get parameter value from the source object
 *
 * @param {*} source
 * @param {string} paramType
 * @param {string} name
 *
 * @returns {*}
 */
function getParam(source, paramType, name) {
    const param = source[paramType] || source;
    return name ? param[name] : param;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHByZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQXdHO0FBQ3hHLHVDQUEyQztBQUUzQyxpQ0FBMEc7QUFDMUcsNkNBQStFO0FBRS9FOzs7OztHQUtHO0FBQ0gsMkJBQWtDLEdBQXFCLEVBQUUsV0FBbUI7SUFDMUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQWdCLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBRS9FLDJEQUEyRDtJQUMzRCxHQUFHLENBQUMsR0FBRyxDQUFDLG1DQUFzQixFQUFFLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBTEQsOENBS0M7QUFFRDs7Ozs7O0dBTUc7QUFDSCw0QkFBNEIsR0FBeUIsRUFBRSxVQUFnQjtJQUNyRSxNQUFNLFVBQVUsR0FBaUIsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzNELE1BQU0sSUFBSSxHQUFnQixjQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDOUMsTUFBTSxNQUFNLEdBQVcsZ0JBQU0sRUFBRSxDQUFDO0lBQ2hDLE1BQU0sTUFBTSxHQUFXLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDbkMsTUFBTSxHQUFHLEdBQVcsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUM3QixNQUFNLE1BQU0sR0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBRW5DOzs7OztPQUtHO0lBQ0gsTUFBTSxnQkFBZ0IsR0FBcUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztTQUMvRCxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyw4QkFBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBRXBEOztPQUVHO0lBQ0gsSUFBSSxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUU7UUFDM0IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLGdCQUFn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QUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQzdDLE1BQU07WUFDUixLQUFLLG9CQUFhLENBQUMsT0FBTztnQkFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLFFBQVEsQ0FBQyxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUM3QyxNQUFNO1NBQ1Q7S0FFRjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUVEOzs7Ozs7R0FNRztBQUNILHVCQUF1QixVQUFnQjtJQUNyQyxJQUFJO1FBQ0YsT0FBTyxjQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0tBQ2xDO0lBQUMsV0FBTTtRQUNOLE9BQU8sSUFBSSxVQUFVLEVBQUUsQ0FBQztLQUN6QjtBQUNILENBQUM7QUFFRDs7Ozs7Ozs7R0FRRztBQUNILGtCQUFrQixNQUFXLEVBQUUsU0FBaUIsRUFBRSxJQUFZO0lBQzVELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUM7SUFFMUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3BDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0SGFuZGxlciwgQXBwbGljYXRpb24sIFJvdXRlciwgRXhwcmVzcywgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgQ29udGFpbmVyIH0gZnJvbSAnQGRlY29yYXRvcnMvZGknO1xuXG5pbXBvcnQgeyBFeHByZXNzTWV0YSwgZ2V0TWV0YSwgUGFyYW1ldGVyVHlwZSwgRXhwcmVzc0NsYXNzLCBSb3V0ZSwgUGFyYW1ldGVyQ29uZmlndXJhdGlvbiB9IGZyb20gJy4vbWV0YSc7XG5pbXBvcnQgeyBtaWRkbGV3YXJlSGFuZGxlciwgZXJyb3JNaWRkbGV3YXJlSGFuZGxlciwgVHlwZSB9IGZyb20gJy4vbWlkZGxld2FyZSc7XG5cbi8qKlxuICogQXR0YWNoIGNvbnRyb2xsZXJzIHRvIGV4cHJlc3MgYXBwbGljYXRpb25cbiAqXG4gKiBAcGFyYW0ge0V4cHJlc3N9IGFwcCBFeHByZXNzIGFwcGxpY2F0aW9uXG4gKiBAcGFyYW0ge1R5cGVbXX0gY29udHJvbGxlcnMgQ29udHJvbGxlcnMgYXJyYXlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaENvbnRyb2xsZXJzKGFwcDogRXhwcmVzcyB8IFJvdXRlciwgY29udHJvbGxlcnM6IFR5cGVbXSkge1xuICBjb250cm9sbGVycy5mb3JFYWNoKChjb250cm9sbGVyOiBUeXBlKSA9PiByZWdpc3RlckNvbnRyb2xsZXIoYXBwLCBjb250cm9sbGVyKSk7XG5cbiAgLy8gZXJyb3IgbWlkZGxld2FyZSBtdXN0IGJlIHJlZ2lzdGVyZWQgYXMgdGhlIHZlcnkgbGFzdCBvbmVcbiAgYXBwLnVzZShlcnJvck1pZGRsZXdhcmVIYW5kbGVyKCkpO1xufVxuXG4vKipcbiAqIFJlZ2lzdGVyIGNvbnRyb2xsZXIgdmlhIHJlZ2lzdGVyaW5nIG5ldyBSb3V0ZXJcbiAqXG4gKiBAcGFyYW0ge0FwcGxpY2F0aW9ufSBhcHBcbiAqIEBwYXJhbSB7RXhwcmVzc0NsYXNzfSBDb250cm9sbGVyXG4gKiBAcmV0dXJuc1xuICovXG5mdW5jdGlvbiByZWdpc3RlckNvbnRyb2xsZXIoYXBwOiBBcHBsaWNhdGlvbiB8IFJvdXRlciwgQ29udHJvbGxlcjogVHlwZSkge1xuICBjb25zdCBjb250cm9sbGVyOiBFeHByZXNzQ2xhc3MgPSBnZXRDb250cm9sbGVyKENvbnRyb2xsZXIpO1xuICBjb25zdCBtZXRhOiBFeHByZXNzTWV0YSA9IGdldE1ldGEoY29udHJvbGxlcik7XG4gIGNvbnN0IHJvdXRlcjogUm91dGVyID0gUm91dGVyKCk7XG4gIGNvbnN0IHJvdXRlczogb2JqZWN0ID0gbWV0YS5yb3V0ZXM7XG4gIGNvbnN0IHVybDogc3RyaW5nID0gbWV0YS51cmw7XG4gIGNvbnN0IHBhcmFtczogb2JqZWN0ID0gbWV0YS5wYXJhbXM7XG5cbiAgLyoqXG4gICAqIFdyYXAgYWxsIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSB3aXRoIGhlbHBlciBmdW5jdGlvblxuICAgKiB0aGF0IGNhbiBpbnN0YW50aWF0ZSBvciBnZXQgZnJvbSB0aGUgY29udGFpbmVyIGluc3RhbmNlIG9mIHRoZSBjbGFzc1xuICAgKiBvciBleGVjdXRlIGdpdmVuIG1pZGRsZXdhcmUgZnVuY3Rpb25cbiAgICogQHNlZSBnZXRNaWRkbGV3YXJlXG4gICAqL1xuICBjb25zdCByb3V0ZXJNaWRkbGV3YXJlOiBSZXF1ZXN0SGFuZGxlcltdID0gKG1ldGEubWlkZGxld2FyZSB8fCBbXSlcbiAgICAubWFwKG1pZGRsZXdhcmUgPT4gbWlkZGxld2FyZUhhbmRsZXIobWlkZGxld2FyZSkpO1xuXG4gIC8qKlxuICAgKiBBcHBseSByb3V0ZXIgbWlkZGxld2FyZVxuICAgKi9cbiAgaWYgKHJvdXRlck1pZGRsZXdhcmUubGVuZ3RoKSB7XG4gICAgcm91dGVyLnVzZSguLi5yb3V0ZXJNaWRkbGV3YXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseWluZyByZWdpc3RlcmVkIHJvdXRlc1xuICAgKi9cbiAgZm9yIChjb25zdCBtZXRob2ROYW1lIG9mIE9iamVjdC5rZXlzKHJvdXRlcykpIHtcbiAgICBjb25zdCByb3V0ZTogUm91dGUgPSByb3V0ZXNbbWV0aG9kTmFtZV07XG5cbiAgICBjb25zdCByb3V0ZUhhbmRsZXIgPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSBleHRyYWN0UGFyYW1ldGVycyhyZXEsIHJlcywgbmV4dCwgcGFyYW1zW21ldGhvZE5hbWVdKTtcbiAgICAgIGNvbnN0IGhhbmRsZXIgPSBjb250cm9sbGVyW21ldGhvZE5hbWVdLmFwcGx5KGNvbnRyb2xsZXIsIGFyZ3MpO1xuXG4gICAgICBpZiAoaGFuZGxlciBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICBoYW5kbGVyLmNhdGNoKG5leHQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaGFuZGxlcjtcbiAgICB9O1xuXG4gICAgY29uc3Qgcm91dGVNaWRkbGV3YXJlOiBSZXF1ZXN0SGFuZGxlcltdID0gKHJvdXRlLm1pZGRsZXdhcmUgfHwgW10pXG4gICAgICAubWFwKG1pZGRsZXdhcmUgPT4gbWlkZGxld2FyZUhhbmRsZXIobWlkZGxld2FyZSkpO1xuXG4gICAgcm91dGVyW3JvdXRlLm1ldGhvZF0uYXBwbHkocm91dGVyLCBbXG4gICAgICByb3V0ZS51cmwsIC4uLnJvdXRlTWlkZGxld2FyZSwgcm91dGVIYW5kbGVyXG4gICAgXSk7XG4gIH1cblxuICBhcHAudXNlKHVybCwgcm91dGVyKTtcblxuICByZXR1cm4gYXBwO1xufVxuXG4vKipcbiAqIEV4dHJhY3QgcGFyYW1ldGVycyBmb3IgaGFuZGxlcnNcbiAqXG4gKiBAcGFyYW0ge1JlcXVlc3R9IHJlcVxuICogQHBhcmFtIHtSZXNwb25zZX0gcmVzXG4gKiBAcGFyYW0ge05leHRGdW5jdGlvbn0gbmV4dFxuICogQHBhcmFtIHtQYXJhbWV0ZXJDb25maWd1cmF0aW9uW119IHBhcmFtc1xuICpcbiAqIEByZXR1cm5zIHthbnlbXX1cbiAqL1xuZnVuY3Rpb24gZXh0cmFjdFBhcmFtZXRlcnMocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24sIHBhcmFtczogUGFyYW1ldGVyQ29uZmlndXJhdGlvbltdKTogYW55W10ge1xuICBpZiAoIXBhcmFtcyB8fCAhcGFyYW1zLmxlbmd0aCkge1xuICAgIHJldHVybiBbIHJlcSwgcmVzLCBuZXh0IF07XG4gIH1cblxuICBjb25zdCBhcmdzID0gW107XG5cbiAgZm9yIChjb25zdCB7IG5hbWUsIGluZGV4LCB0eXBlIH0gb2YgcGFyYW1zKSB7XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5SRVNQT05TRTpcbiAgICAgICAgYXJnc1tpbmRleF0gPSByZXM7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlJFUVVFU1Q6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCBudWxsLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuTkVYVDpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBuZXh0O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5QQVJBTVM6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAncGFyYW1zJywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlFVRVJZOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ3F1ZXJ5JywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkJPRFk6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAnYm9keScsIG5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5IRUFERVJTOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ2hlYWRlcnMnLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuQ09PS0lFUzpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBnZXRQYXJhbShyZXEsICdjb29raWVzJywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICB9XG5cbiAgcmV0dXJuIGFyZ3M7XG59XG5cbi8qKlxuICogR2V0IGNvbnRyb2xsZXIgaW5zdGFuY2UgZnJvbSBjb250YWluZXIgb3IgaW5zdGFudGlhdGUgb25lXG4gKlxuICogQHBhcmFtIHthbnl9IENvbnRyb2xsZXJcbiAqXG4gKiBAcmV0dXJucyB7RXhwcmVzc0NsYXNzfVxuICovXG5mdW5jdGlvbiBnZXRDb250cm9sbGVyKENvbnRyb2xsZXI6IFR5cGUpOiBFeHByZXNzQ2xhc3Mge1xuICB0cnkge1xuICAgIHJldHVybiBDb250YWluZXIuZ2V0KENvbnRyb2xsZXIpO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gbmV3IENvbnRyb2xsZXIoKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBwYXJhbWV0ZXIgdmFsdWUgZnJvbSB0aGUgc291cmNlIG9iamVjdFxuICpcbiAqIEBwYXJhbSB7Kn0gc291cmNlXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1UeXBlXG4gKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICpcbiAqIEByZXR1cm5zIHsqfVxuICovXG5mdW5jdGlvbiBnZXRQYXJhbShzb3VyY2U6IGFueSwgcGFyYW1UeXBlOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IGFueSB7XG4gIGNvbnN0IHBhcmFtID0gc291cmNlW3BhcmFtVHlwZV0gfHwgc291cmNlO1xuXG4gIHJldHVybiBuYW1lID8gcGFyYW1bbmFtZV0gOiBwYXJhbTtcbn1cbiJdfQ==